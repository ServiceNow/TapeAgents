
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="TapeAgents is a framework that facilitates all stages of the LLM Agent development lifecycle">
      
      
      
      
        <link rel="prev" href="../llms/">
      
      
        <link rel="next" href="../observe/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.46">
    
    
      
        <title>Nodes - TapeAgents Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tapeagents.nodes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TapeAgents Documentation" class="md-header__button md-logo" aria-label="TapeAgents Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TapeAgents Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nodes
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ServiceNow/TapeAgents" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    ServiceNow/TapeAgents
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TapeAgents Documentation" class="md-nav__button md-logo" aria-label="TapeAgents Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TapeAgents Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ServiceNow/TapeAgents" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    ServiceNow/TapeAgents
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Agent
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../batch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Batch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../demo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Demo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dialog_tape/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dialog Tape
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../finetune/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Finetune
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Finetune
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/checkpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Checkpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Context
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/eval/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Eval
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/finetune/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Finetune
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/logging_/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/lora/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lora
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/optim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optim
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../finetune/rl/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    RL
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_8_9" id="__nav_3_8_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_9">
            <span class="md-nav__icon md-icon"></span>
            RL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/rl/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../finetune/types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Types
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm_function/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLM Function
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLMs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Nodes
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Nodes
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;nodes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.CallSubagent" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CallSubagent
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.ControlFlowNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ControlFlowNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ControlFlowNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.ControlFlowNode.generate_steps" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.ControlFlowNode.select_node" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;select_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.FixedStepsNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;FixedStepsNode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;MonoNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" MonoNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.generate_steps" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.get_steps_description" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_steps_description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.make_llm_output" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;make_llm_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.make_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;make_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.parse_completion" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;parse_completion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.postprocess_step" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;postprocess_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.prepare_tape" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;prepare_tape
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.tape_to_messages" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;tape_to_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.trim_tape" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;trim_tape
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.ObservationControlNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ObservationControlNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ObservationControlNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.ObservationControlNode.select_node" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;select_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../observe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../orchestrator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Orchestrator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parallel_processing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Parallel Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prompting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prompting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_17" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../renderers/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Renderers
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_17" id="__nav_3_17_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_17">
            <span class="md-nav__icon md-icon"></span>
            Renderers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../renderers/basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../renderers/camera_ready_renderer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Camera Ready Renderer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../renderers/pretty/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pretty
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../studio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Studio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tape_browser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tape Browser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../team/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Team
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_21" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../tools/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_21" id="__nav_3_21_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_21_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_21">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/calculator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Calculator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/container_executor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Container Executor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/document_converters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Document Converters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/gym_browser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gym Browser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/python_interpreter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Interpreter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/simple_browser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simple Browser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/stock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stock
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../view/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    View
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;nodes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.CallSubagent" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CallSubagent
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.ControlFlowNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ControlFlowNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ControlFlowNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.ControlFlowNode.generate_steps" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.ControlFlowNode.select_node" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;select_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.FixedStepsNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;FixedStepsNode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;MonoNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" MonoNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.generate_steps" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_steps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.get_steps_description" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_steps_description
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.make_llm_output" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;make_llm_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.make_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;make_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.parse_completion" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;parse_completion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.postprocess_step" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;postprocess_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.prepare_tape" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;prepare_tape
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.tape_to_messages" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;tape_to_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.MonoNode.trim_tape" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;trim_tape
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tapeagents.nodes.ObservationControlNode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ObservationControlNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ObservationControlNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tapeagents.nodes.ObservationControlNode.select_node" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;select_node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Nodes</h1>

<div class="doc doc-object doc-module">



<a id="tapeagents.nodes"></a>
    <div class="doc doc-contents first">

        <p>Nodes are the building blocks of a TapeAgent, representing atomic units of the agent's behavior.</p>







<p><span class="doc-section-title">Classes:</span></p>
    <ul>
        <li class="doc-section-item field-body">
          <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.CallSubagent" href="#tapeagents.nodes.CallSubagent">CallSubagent</a></code></b>
          –
          <div class="doc-md-description">
            <p>Node that calls a subagent with inputs from the current tape view.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.ControlFlowNode" href="#tapeagents.nodes.ControlFlowNode">ControlFlowNode</a></code></b>
          –
          <div class="doc-md-description">
            <p>A node that controls the flow of execution by selecting the next node based on tape content.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.FixedStepsNode" href="#tapeagents.nodes.FixedStepsNode">FixedStepsNode</a></code></b>
          –
          <div class="doc-md-description">
            <p>A Node that generates a fixed sequence of predefined steps.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode" href="#tapeagents.nodes.MonoNode">MonoNode</a></code></b>
          –
          <div class="doc-md-description">
            <p>A node for simple monolithic agents that handles simple prompt generation, and universal LLM output parsing.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.ObservationControlNode" href="#tapeagents.nodes.ObservationControlNode">ObservationControlNode</a></code></b>
          –
          <div class="doc-md-description">
            <p>A control flow node that selects the next node based on the last observation in the tape.</p>
          </div>
        </li>
    </ul>







  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="tapeagents.nodes.CallSubagent" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CallSubagent</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="tapeagents.agent.Node" href="../agent/#tapeagents.agent.Node">Node</a></code></p>


        <p>Node that calls a subagent with inputs from the current tape view.</p>










              <details class="quote">
                <summary>Source code in <code>tapeagents/nodes.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CallSubagent</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Node that calls a subagent with inputs from the current tape view.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">tuple</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Names of the subagents which outputs are required for the current subagent to run&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">Node&quot;</span>

    <span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">:</span> <span class="n">LLMStream</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">TapeViewStack</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">Call</span><span class="p">(</span><span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">input_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">view</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span><span class="o">.</span><span class="n">model_copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="tapeagents.nodes.ControlFlowNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ControlFlowNode</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="tapeagents.agent.Node" href="../agent/#tapeagents.agent.Node">Node</a></code></p>


        <p>A node that controls the flow of execution by selecting the next node based on tape content.</p>
<p>This abstract class provides a framework for implementing control flow logic in a node.
It determines which node should be executed next based on the current state of the tape.</p>


<details class="example" open>
  <summary>Example</summary>
  <pre><code class="language-python">class MyControlFlow(ControlFlowNode):
    def select_node(self, tape):
        if isinstance(tape[-1], SuccessObservation):
            return 'node_a'
        return 'node_b'
</code></pre>
</details>








<p><span class="doc-section-title">Methods:</span></p>
    <ul>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.ControlFlowNode.generate_steps" href="#tapeagents.nodes.ControlFlowNode.generate_steps">generate_steps</a></code></b>
            –
            <div class="doc-md-description">
              <p>Generates steps that moves the execution to the next node based on the tape content.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.ControlFlowNode.select_node" href="#tapeagents.nodes.ControlFlowNode.select_node">select_node</a></code></b>
            –
            <div class="doc-md-description">
              <p>Select the next node based on the provided tape.</p>
            </div>
          </li>
    </ul>



              <details class="quote">
                <summary>Source code in <code>tapeagents/nodes.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ControlFlowNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A node that controls the flow of execution by selecting the next node based on tape content.</span>

<span class="sd">    This abstract class provides a framework for implementing control flow logic in a node.</span>
<span class="sd">    It determines which node should be executed next based on the current state of the tape.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyControlFlow(ControlFlowNode):</span>
<span class="sd">            def select_node(self, tape):</span>
<span class="sd">                if isinstance(tape[-1], SuccessObservation):</span>
<span class="sd">                    return &#39;node_a&#39;</span>
<span class="sd">                return &#39;node_b&#39;</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">:</span> <span class="n">LLMStream</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span> <span class="o">|</span> <span class="n">PartialStep</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates steps that moves the execution to the next node based on the tape content.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Any): The agent instance executing the node</span>
<span class="sd">            tape (Tape): The tape object containing the context and state</span>
<span class="sd">            llm_stream (LLMStream): Stream for language model interaction</span>

<span class="sd">        Yields:</span>
<span class="sd">            step (SetNextNode): A step indicating which node should be executed next</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="n">SetNextNode</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">select_node</span><span class="p">(</span><span class="n">tape</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">select_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the next node based on the provided tape.</span>

<span class="sd">        This method should be implemented in a subclass to define the logic for selecting the next node.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): The tape object containing the necessary information for node selection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The identifier of the next node.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the method is not implemented in the subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Implement this method in the subclass to set the next node according to your logic&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.ControlFlowNode.generate_steps" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate_steps</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generates steps that moves the execution to the next node based on the tape content.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>agent</code></b>
              (<code><span title="typing.Any">Any</span></code>)
          –
          <div class="doc-md-description">
            <p>The agent instance executing the node</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object containing the context and state</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>llm_stream</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.llms.LLMStream" href="../llms/#tapeagents.llms.LLMStream">LLMStream</a></code>)
          –
          <div class="doc-md-description">
            <p>Stream for language model interaction</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Yields:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>step</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.SetNextNode" href="../core/#tapeagents.core.SetNextNode">SetNextNode</a></code>
)          –
          <div class="doc-md-description">
            <p>A step indicating which node should be executed next</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">:</span> <span class="n">LLMStream</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span> <span class="o">|</span> <span class="n">PartialStep</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates steps that moves the execution to the next node based on the tape content.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent (Any): The agent instance executing the node</span>
<span class="sd">        tape (Tape): The tape object containing the context and state</span>
<span class="sd">        llm_stream (LLMStream): Stream for language model interaction</span>

<span class="sd">    Yields:</span>
<span class="sd">        step (SetNextNode): A step indicating which node should be executed next</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="n">SetNextNode</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">select_node</span><span class="p">(</span><span class="n">tape</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.ControlFlowNode.select_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">select_node</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Select the next node based on the provided tape.</p>
<p>This method should be implemented in a subclass to define the logic for selecting the next node.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object containing the necessary information for node selection.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>str</code></b> (              <code>str</code>
)          –
          <div class="doc-md-description">
            <p>The identifier of the next node.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code>NotImplementedError</code>
            –
          <div class="doc-md-description">
            <p>If the method is not implemented in the subclass.</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">select_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select the next node based on the provided tape.</span>

<span class="sd">    This method should be implemented in a subclass to define the logic for selecting the next node.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): The tape object containing the necessary information for node selection.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The identifier of the next node.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If the method is not implemented in the subclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Implement this method in the subclass to set the next node according to your logic&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="tapeagents.nodes.FixedStepsNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>FixedStepsNode</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="tapeagents.agent.Node" href="../agent/#tapeagents.agent.Node">Node</a></code></p>


        <p>A Node that generates a fixed sequence of predefined steps.</p>
<p>This node simply yields a sequence of steps that were provided during initialization,
without any dynamic generation or modification.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <ul>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.FixedStepsNode.steps">steps</span></code></b>
              (<code>list[<a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a>]</code>)
          –
          <div class="doc-md-description">
            <p>A list of Step objects to be yielded in sequence.</p>
          </div>
        </li>
    </ul>


<details class="example" open>
  <summary>Example</summary>
  <pre><code class="language-python">fixed_node = FixedStepsNode(steps=[
    AssistantStep(text=&quot;Hello&quot;),
    SetNextNode(next_node=&quot;node_a&quot;)
])
</code></pre>
</details>









              <details class="quote">
                <summary>Source code in <code>tapeagents/nodes.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FixedStepsNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Node that generates a fixed sequence of predefined steps.</span>

<span class="sd">    This node simply yields a sequence of steps that were provided during initialization,</span>
<span class="sd">    without any dynamic generation or modification.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        steps (list[Step]): A list of Step objects to be yielded in sequence.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        fixed_node = FixedStepsNode(steps=[</span>
<span class="sd">            AssistantStep(text=&quot;Hello&quot;),</span>
<span class="sd">            SetNextNode(next_node=&quot;node_a&quot;)</span>
<span class="sd">        ])</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Step</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">:</span> <span class="n">LLMStream</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span> <span class="o">|</span> <span class="n">PartialStep</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="tapeagents.nodes.MonoNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>MonoNode</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="tapeagents.agent.Node" href="../agent/#tapeagents.agent.Node">Node</a></code></p>


        <p>A node for simple monolithic agents that handles simple prompt generation, and universal LLM output parsing.</p>
<p>This node performs the following functions:</p>
<ul>
<li>Renders the entire tape into a prompt, trimming if needed</li>
<li>Attaches guidance text to the end of the prompt after rendering the tape</li>
<li>Parses the LLM output into provided step classes (class provided as annotated union)</li>
</ul>


<p><span class="doc-section-title">Attributes:</span></p>
    <ul>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.MonoNode.guidance">guidance</span></code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>Guidance text attached to the end of the prompt</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.MonoNode.system_prompt">system_prompt</span></code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>System prompt used in message construction</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.MonoNode.steps_prompt">steps_prompt</span></code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>Prompt describing the steps the agent can take</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.MonoNode.agent_step_cls">agent_step_cls</span></code></b>
              (<code><span title="typing.Any">Any</span></code>)
          –
          <div class="doc-md-description">
            <p>Class used for step validation, excluded from model</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.MonoNode.next_node">next_node</span></code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>Identifier for the next node in sequence</p>
          </div>
        </li>
    </ul>


<details class="example" open>
  <summary>Example</summary>
  <pre><code class="language-python">node = MonoNode(
    guidance=&quot;Please respond with next action&quot;,
    system_prompt=&quot;You are a helpful assistant&quot;,
    steps_prompt=&quot;Available steps: think, act, finish&quot;,
    agent_step_cls=AgentStep
)
</code></pre>
</details>








<p><span class="doc-section-title">Methods:</span></p>
    <ul>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.generate_steps" href="#tapeagents.nodes.MonoNode.generate_steps">generate_steps</a></code></b>
            –
            <div class="doc-md-description">
              <p>Generates a sequence of steps based on the LLM stream output.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.get_steps_description" href="#tapeagents.nodes.MonoNode.get_steps_description">get_steps_description</a></code></b>
            –
            <div class="doc-md-description">
              <p>Get the steps description for the agent's task.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.make_llm_output" href="#tapeagents.nodes.MonoNode.make_llm_output">make_llm_output</a></code></b>
            –
            <div class="doc-md-description">
              <p>Creates an LLMOutput from a sequence of steps in the tape that share the same prompt_id.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.make_prompt" href="#tapeagents.nodes.MonoNode.make_prompt">make_prompt</a></code></b>
            –
            <div class="doc-md-description">
              <p>Create a prompt from tape interactions.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.parse_completion" href="#tapeagents.nodes.MonoNode.parse_completion">parse_completion</a></code></b>
            –
            <div class="doc-md-description">
              <p>Parse LLM completion output into a sequence of agent steps.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.postprocess_step" href="#tapeagents.nodes.MonoNode.postprocess_step">postprocess_step</a></code></b>
            –
            <div class="doc-md-description">
              <p>Post-processes a step after its generation.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.prepare_tape" href="#tapeagents.nodes.MonoNode.prepare_tape">prepare_tape</a></code></b>
            –
            <div class="doc-md-description">
              <p>Prepares tape by filtering out control flow steps.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.tape_to_messages" href="#tapeagents.nodes.MonoNode.tape_to_messages">tape_to_messages</a></code></b>
            –
            <div class="doc-md-description">
              <p>Converts a Tape object and steps description into a list of messages for LLM conversation.</p>
            </div>
          </li>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.MonoNode.trim_tape" href="#tapeagents.nodes.MonoNode.trim_tape">trim_tape</a></code></b>
            –
            <div class="doc-md-description">
              <p>Trims the tape by removing unnecessary positions.</p>
            </div>
          </li>
    </ul>



              <details class="quote">
                <summary>Source code in <code>tapeagents/nodes.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MonoNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A node for simple monolithic agents that handles simple prompt generation, and universal LLM output parsing.</span>

<span class="sd">    This node performs the following functions:</span>

<span class="sd">    - Renders the entire tape into a prompt, trimming if needed</span>
<span class="sd">    - Attaches guidance text to the end of the prompt after rendering the tape</span>
<span class="sd">    - Parses the LLM output into provided step classes (class provided as annotated union)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        guidance (str): Guidance text attached to the end of the prompt</span>
<span class="sd">        system_prompt (str): System prompt used in message construction</span>
<span class="sd">        steps_prompt (str): Prompt describing the steps the agent can take</span>
<span class="sd">        agent_step_cls (Any): Class used for step validation, excluded from model</span>
<span class="sd">        next_node (str): Identifier for the next node in sequence</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        node = MonoNode(</span>
<span class="sd">            guidance=&quot;Please respond with next action&quot;,</span>
<span class="sd">            system_prompt=&quot;You are a helpful assistant&quot;,</span>
<span class="sd">            steps_prompt=&quot;Available steps: think, act, finish&quot;,</span>
<span class="sd">            agent_step_cls=AgentStep</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">guidance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># guidance text that is attached to the end of the prompt</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">steps_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># prompt that describes the steps that the agent can take</span>
    <span class="n">agent_step_cls</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">next_node</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Prompt</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a prompt from tape interactions.</span>

<span class="sd">        This method constructs a prompt by processing the tape content and agent steps description</span>
<span class="sd">        into a format suitable for LLM consumption. It includes token count checks and tape trimming</span>
<span class="sd">        if needed to fit within context size limits.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Any): The agent object containing LLM configuration.</span>
<span class="sd">            tape (Tape): The tape object containing interaction history.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Prompt: A Prompt object containing formatted messages for LLM consumption.</span>

<span class="sd">        Note:</span>
<span class="sd">            The method performs the following steps:</span>

<span class="sd">            1. Cleans the tape content</span>
<span class="sd">            2. Gets steps description</span>
<span class="sd">            3. Converts tape to messages</span>
<span class="sd">            4. Checks token count and trims if needed</span>
<span class="sd">            5. Reconstructs messages if trimming occurred</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cleaned_tape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_tape</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span>
        <span class="n">steps_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_steps_description</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tape_to_messages</span><span class="p">(</span><span class="n">cleaned_tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">context_size</span> <span class="o">-</span> <span class="mi">500</span><span class="p">):</span>
            <span class="n">cleaned_tape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_tape</span><span class="p">(</span><span class="n">cleaned_tape</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tape_to_messages</span><span class="p">(</span><span class="n">cleaned_tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Prompt</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_tape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tape</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares tape by filtering out control flow steps.</span>

<span class="sd">        This method creates a new tape instance with only non-control flow steps,</span>
<span class="sd">        specifically excluding SetNextNode instances.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): The input tape containing a sequence of steps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tape: A new tape instance containing only non-control flow steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">steps_without_control_flow</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">SetNextNode</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">tape</span><span class="o">.</span><span class="n">model_copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps_without_control_flow</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">make_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an LLMOutput from a sequence of steps in the tape that share the same prompt_id.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Any): The agent instance associated with the output.</span>
<span class="sd">            tape (Tape): The tape containing the sequence of steps.</span>
<span class="sd">            index (int): The starting index in the tape to process steps from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            LLMOutput: An output object containing:</span>

<span class="sd">                - role: Set to &quot;assistant&quot;</span>
<span class="sd">                - content: JSON string of step data, formatted as either: a single dictionary</span>
<span class="sd">                if there is only one step, or a list of dictionaries</span>

<span class="sd">        Note:</span>
<span class="sd">            - Only processes steps with matching prompt_id from the starting index</span>
<span class="sd">            - Excludes SetNextNode steps from the output</span>
<span class="sd">            - JSON content is formatted with indentation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">first_prompt_id</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">prompt_id</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">prompt_id</span> <span class="o">==</span> <span class="n">first_prompt_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SetNextNode</span><span class="p">):</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># if there is only one step, return it as a single dict, not a list</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">llm_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">llm_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LLMOutput</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tape_to_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a Tape object and steps description into a list of messages for LLM conversation.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): A Tape object containing conversation steps.</span>
<span class="sd">            steps_description (str): A description of the conversation steps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict]: A list of dictionaries representing the conversation messages.</span>
<span class="sd">                       Each dictionary contains &#39;role&#39; and &#39;content&#39; keys.</span>
<span class="sd">                       Roles can be &#39;system&#39;, &#39;user&#39;, or &#39;assistant&#39;.</span>
<span class="sd">                       The system prompt is always the first message.</span>
<span class="sd">                       If steps_description is provided, it&#39;s added as a user message.</span>
<span class="sd">                       Messages from tape are added with roles based on step type.</span>
<span class="sd">                       If guidance exists, it&#39;s added as the final user message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">steps_description</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">steps_description</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tape</span><span class="p">:</span>
            <span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;assistant&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">AgentStep</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;user&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">step</span><span class="o">.</span><span class="n">llm_view</span><span class="p">()})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guidance</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">guidance</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">messages</span>

    <span class="k">def</span> <span class="nf">get_steps_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the steps description for the agent&#39;s task.</span>

<span class="sd">        This method returns the predefined steps prompt which describes the sequence of actions</span>
<span class="sd">        or steps that the agent should follow.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): The tape object containing the context and state information.</span>
<span class="sd">            agent (Any): The agent object that will execute the steps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The steps prompt describing the sequence of actions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_prompt</span>

    <span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">:</span> <span class="n">LLMStream</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span> <span class="o">|</span> <span class="n">PartialStep</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a sequence of steps based on the LLM stream output.</span>

<span class="sd">        This method processes the output from a language model stream and converts it into a series of steps.</span>
<span class="sd">        It handles the parsing of completions and post-processing of steps.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Any): The agent instance that will execute the steps.</span>
<span class="sd">            tape (Tape): The tape object containing the execution context and history.</span>
<span class="sd">            llm_stream (LLMStream): The stream of language model outputs to process.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Union[Step, PartialStep]: Individual steps generated from the LLM stream output.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FatalError: If no completions are generated from the LLM stream.</span>

<span class="sd">        Note:</span>
<span class="sd">            - If the node has a next_node defined and the final step is not a StopStep,</span>
<span class="sd">              it will yield a SetNextNode step to continue the execution flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">llm_stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">content</span>
                    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_completion</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">llm_stream</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_step</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">new_steps</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                        <span class="n">new_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">step</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cnt</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FatalError</span><span class="p">(</span><span class="s2">&quot;No completions!&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FatalError</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_node</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">StopStep</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">SetNextNode</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">postprocess_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">new_steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Step</span><span class="p">],</span> <span class="n">step</span><span class="p">:</span> <span class="n">Step</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Step</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post-processes a step after its generation.</span>

<span class="sd">        By default returns the step unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): The tape</span>
<span class="sd">            new_steps (list[Step]): List of new steps that were generated during the current iteration</span>
<span class="sd">            step (Step): The step that was just generated</span>

<span class="sd">        Returns:</span>
<span class="sd">            Step: The processed step, by default returns the original step unmodified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">step</span>

    <span class="k">def</span> <span class="nf">parse_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse LLM completion output into a sequence of agent steps.</span>

<span class="sd">        This method processes the LLM output string by parsing it as JSON and validating it against</span>
<span class="sd">        the agent step class schema. It handles both single step and multi-step outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            llm_output (str): The raw output string from the LLM to be parsed</span>
<span class="sd">            prompt_id (str): Identifier for the prompt that generated this completion</span>

<span class="sd">        Yields:</span>
<span class="sd">            Step: Individual validated agent steps with prompt_id metadata</span>
<span class="sd">            LLMOutputParsingFailureAction: Error information if parsing or validation fails</span>

<span class="sd">        Note:</span>
<span class="sd">            All parsing errors are handled internally and yielded as</span>
<span class="sd">            LLMOutputParsingFailureAction objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">step_dicts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sanitize_json_completion</span><span class="p">(</span><span class="n">llm_output</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_dicts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">step_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_dicts</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output as json: </span><span class="si">{</span><span class="n">llm_output</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">LLMOutputParsingFailureAction</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output as json: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">TypeAdapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_step_cls</span><span class="p">)</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">step_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">step_dict</span> <span class="ow">in</span> <span class="n">step_dicts</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">():</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]])</span>
                <span class="n">err_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to validate LLM output: </span><span class="si">{</span><span class="n">step_dicts</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Errors:</span><span class="se">\n</span><span class="si">{</span><span class="n">err_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">LLMOutputParsingFailureAction</span><span class="p">(</span>
                <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to validate LLM output: </span><span class="si">{</span><span class="n">err_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output dict: </span><span class="si">{</span><span class="n">step_dicts</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">LLMOutputParsingFailureAction</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output dict: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">prompt_id</span> <span class="o">=</span> <span class="n">prompt_id</span>
            <span class="k">yield</span> <span class="n">step</span>

    <span class="k">def</span> <span class="nf">trim_tape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tape</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trims the tape by removing unnecessary positions.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): The tape object to be trimmed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tape: The trimmed tape object.</span>

<span class="sd">        Note:</span>
<span class="sd">            Currently this is a placeholder method that returns the tape unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tape</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.generate_steps" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate_steps</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generates a sequence of steps based on the LLM stream output.</p>
<p>This method processes the output from a language model stream and converts it into a series of steps.
It handles the parsing of completions and post-processing of steps.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>agent</code></b>
              (<code><span title="typing.Any">Any</span></code>)
          –
          <div class="doc-md-description">
            <p>The agent instance that will execute the steps.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object containing the execution context and history.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>llm_stream</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.llms.LLMStream" href="../llms/#tapeagents.llms.LLMStream">LLMStream</a></code>)
          –
          <div class="doc-md-description">
            <p>The stream of language model outputs to process.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Yields:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a> | <a class="autorefs autorefs-internal" title="tapeagents.core.PartialStep" href="../core/#tapeagents.core.PartialStep">PartialStep</a></code>
          –
          <div class="doc-md-description">
            <p>Union[Step, PartialStep]: Individual steps generated from the LLM stream output.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Raises:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code><span title="tapeagents.utils.FatalError">FatalError</span></code>
            –
          <div class="doc-md-description">
            <p>If no completions are generated from the LLM stream.</p>
          </div>
        </li>
    </ul>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>If the node has a next_node defined and the final step is not a StopStep,
  it will yield a SetNextNode step to continue the execution flow.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_steps</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">llm_stream</span><span class="p">:</span> <span class="n">LLMStream</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span> <span class="o">|</span> <span class="n">PartialStep</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a sequence of steps based on the LLM stream output.</span>

<span class="sd">    This method processes the output from a language model stream and converts it into a series of steps.</span>
<span class="sd">    It handles the parsing of completions and post-processing of steps.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent (Any): The agent instance that will execute the steps.</span>
<span class="sd">        tape (Tape): The tape object containing the execution context and history.</span>
<span class="sd">        llm_stream (LLMStream): The stream of language model outputs to process.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Union[Step, PartialStep]: Individual steps generated from the LLM stream output.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FatalError: If no completions are generated from the LLM stream.</span>

<span class="sd">    Note:</span>
<span class="sd">        - If the node has a next_node defined and the final step is not a StopStep,</span>
<span class="sd">          it will yield a SetNextNode step to continue the execution flow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">llm_stream</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">content</span>
                <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_completion</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">llm_stream</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_step</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">new_steps</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                    <span class="n">new_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">step</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cnt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FatalError</span><span class="p">(</span><span class="s2">&quot;No completions!&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FatalError</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_node</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">StopStep</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">SetNextNode</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.get_steps_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_steps_description</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the steps description for the agent's task.</p>
<p>This method returns the predefined steps prompt which describes the sequence of actions
or steps that the agent should follow.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object containing the context and state information.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>agent</code></b>
              (<code><span title="typing.Any">Any</span></code>)
          –
          <div class="doc-md-description">
            <p>The agent object that will execute the steps.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>str</code></b> (              <code>str</code>
)          –
          <div class="doc-md-description">
            <p>The steps prompt describing the sequence of actions.</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_steps_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the steps description for the agent&#39;s task.</span>

<span class="sd">    This method returns the predefined steps prompt which describes the sequence of actions</span>
<span class="sd">    or steps that the agent should follow.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): The tape object containing the context and state information.</span>
<span class="sd">        agent (Any): The agent object that will execute the steps.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The steps prompt describing the sequence of actions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_prompt</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.make_llm_output" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">make_llm_output</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">tape</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creates an LLMOutput from a sequence of steps in the tape that share the same prompt_id.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>agent</code></b>
              (<code><span title="typing.Any">Any</span></code>)
          –
          <div class="doc-md-description">
            <p>The agent instance associated with the output.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape containing the sequence of steps.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>index</code></b>
              (<code>int</code>)
          –
          <div class="doc-md-description">
            <p>The starting index in the tape to process steps from.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>LLMOutput</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.LLMOutput" href="../core/#tapeagents.core.LLMOutput">LLMOutput</a></code>
)          –
          <div class="doc-md-description">
            <p>An output object containing:</p>
<ul>
<li>role: Set to "assistant"</li>
<li>content: JSON string of step data, formatted as either: a single dictionary
if there is only one step, or a list of dictionaries</li>
</ul>
          </div>
        </li>
    </ul>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>Only processes steps with matching prompt_id from the starting index</li>
<li>Excludes SetNextNode steps from the output</li>
<li>JSON content is formatted with indentation</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an LLMOutput from a sequence of steps in the tape that share the same prompt_id.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent (Any): The agent instance associated with the output.</span>
<span class="sd">        tape (Tape): The tape containing the sequence of steps.</span>
<span class="sd">        index (int): The starting index in the tape to process steps from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        LLMOutput: An output object containing:</span>

<span class="sd">            - role: Set to &quot;assistant&quot;</span>
<span class="sd">            - content: JSON string of step data, formatted as either: a single dictionary</span>
<span class="sd">            if there is only one step, or a list of dictionaries</span>

<span class="sd">    Note:</span>
<span class="sd">        - Only processes steps with matching prompt_id from the starting index</span>
<span class="sd">        - Excludes SetNextNode steps from the output</span>
<span class="sd">        - JSON content is formatted with indentation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">index</span>
    <span class="n">first_prompt_id</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">prompt_id</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">prompt_id</span> <span class="o">==</span> <span class="n">first_prompt_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SetNextNode</span><span class="p">):</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tape</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># if there is only one step, return it as a single dict, not a list</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">llm_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">llm_dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">LLMOutput</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.make_prompt" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">make_prompt</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">tape</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a prompt from tape interactions.</p>
<p>This method constructs a prompt by processing the tape content and agent steps description
into a format suitable for LLM consumption. It includes token count checks and tape trimming
if needed to fit within context size limits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>agent</code></b>
              (<code><span title="typing.Any">Any</span></code>)
          –
          <div class="doc-md-description">
            <p>The agent object containing LLM configuration.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object containing interaction history.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>Prompt</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Prompt" href="../core/#tapeagents.core.Prompt">Prompt</a></code>
)          –
          <div class="doc-md-description">
            <p>A Prompt object containing formatted messages for LLM consumption.</p>
          </div>
        </li>
    </ul>


<details class="note" open>
  <summary>Note</summary>
  <p>The method performs the following steps:</p>
<ol>
<li>Cleans the tape content</li>
<li>Gets steps description</li>
<li>Converts tape to messages</li>
<li>Checks token count and trims if needed</li>
<li>Reconstructs messages if trimming occurred</li>
</ol>
</details>
            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Prompt</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a prompt from tape interactions.</span>

<span class="sd">    This method constructs a prompt by processing the tape content and agent steps description</span>
<span class="sd">    into a format suitable for LLM consumption. It includes token count checks and tape trimming</span>
<span class="sd">    if needed to fit within context size limits.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent (Any): The agent object containing LLM configuration.</span>
<span class="sd">        tape (Tape): The tape object containing interaction history.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Prompt: A Prompt object containing formatted messages for LLM consumption.</span>

<span class="sd">    Note:</span>
<span class="sd">        The method performs the following steps:</span>

<span class="sd">        1. Cleans the tape content</span>
<span class="sd">        2. Gets steps description</span>
<span class="sd">        3. Converts tape to messages</span>
<span class="sd">        4. Checks token count and trims if needed</span>
<span class="sd">        5. Reconstructs messages if trimming occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned_tape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_tape</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span>
    <span class="n">steps_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_steps_description</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tape_to_messages</span><span class="p">(</span><span class="n">cleaned_tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">context_size</span> <span class="o">-</span> <span class="mi">500</span><span class="p">):</span>
        <span class="n">cleaned_tape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_tape</span><span class="p">(</span><span class="n">cleaned_tape</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tape_to_messages</span><span class="p">(</span><span class="n">cleaned_tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Prompt</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.parse_completion" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">parse_completion</span><span class="p">(</span><span class="n">llm_output</span><span class="p">,</span> <span class="n">prompt_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parse LLM completion output into a sequence of agent steps.</p>
<p>This method processes the LLM output string by parsing it as JSON and validating it against
the agent step class schema. It handles both single step and multi-step outputs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>llm_output</code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>The raw output string from the LLM to be parsed</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>prompt_id</code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>Identifier for the prompt that generated this completion</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Yields:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>Step</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a></code>
)          –
          <div class="doc-md-description">
            <p>Individual validated agent steps with prompt_id metadata</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
<b><code>LLMOutputParsingFailureAction</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a></code>
)          –
          <div class="doc-md-description">
            <p>Error information if parsing or validation fails</p>
          </div>
        </li>
    </ul>


<details class="note" open>
  <summary>Note</summary>
  <p>All parsing errors are handled internally and yielded as
LLMOutputParsingFailureAction objects.</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Step</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse LLM completion output into a sequence of agent steps.</span>

<span class="sd">    This method processes the LLM output string by parsing it as JSON and validating it against</span>
<span class="sd">    the agent step class schema. It handles both single step and multi-step outputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        llm_output (str): The raw output string from the LLM to be parsed</span>
<span class="sd">        prompt_id (str): Identifier for the prompt that generated this completion</span>

<span class="sd">    Yields:</span>
<span class="sd">        Step: Individual validated agent steps with prompt_id metadata</span>
<span class="sd">        LLMOutputParsingFailureAction: Error information if parsing or validation fails</span>

<span class="sd">    Note:</span>
<span class="sd">        All parsing errors are handled internally and yielded as</span>
<span class="sd">        LLMOutputParsingFailureAction objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">step_dicts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sanitize_json_completion</span><span class="p">(</span><span class="n">llm_output</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_dicts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">step_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_dicts</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output as json: </span><span class="si">{</span><span class="n">llm_output</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">LLMOutputParsingFailureAction</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output as json: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">TypeAdapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_step_cls</span><span class="p">)</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">step_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">step_dict</span> <span class="ow">in</span> <span class="n">step_dicts</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">err_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">():</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]])</span>
            <span class="n">err_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to validate LLM output: </span><span class="si">{</span><span class="n">step_dicts</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Errors:</span><span class="se">\n</span><span class="si">{</span><span class="n">err_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">LLMOutputParsingFailureAction</span><span class="p">(</span>
            <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to validate LLM output: </span><span class="si">{</span><span class="n">err_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output dict: </span><span class="si">{</span><span class="n">step_dicts</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">LLMOutputParsingFailureAction</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM output dict: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">step</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">prompt_id</span> <span class="o">=</span> <span class="n">prompt_id</span>
        <span class="k">yield</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.postprocess_step" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">postprocess_step</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">new_steps</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Post-processes a step after its generation.</p>
<p>By default returns the step unchanged.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>new_steps</code></b>
              (<code>list[<a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a>]</code>)
          –
          <div class="doc-md-description">
            <p>List of new steps that were generated during the current iteration</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>step</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a></code>)
          –
          <div class="doc-md-description">
            <p>The step that was just generated</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>Step</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Step" href="../core/#tapeagents.core.Step">Step</a></code>
)          –
          <div class="doc-md-description">
            <p>The processed step, by default returns the original step unmodified</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">postprocess_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">new_steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Step</span><span class="p">],</span> <span class="n">step</span><span class="p">:</span> <span class="n">Step</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Step</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Post-processes a step after its generation.</span>

<span class="sd">    By default returns the step unchanged.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): The tape</span>
<span class="sd">        new_steps (list[Step]): List of new steps that were generated during the current iteration</span>
<span class="sd">        step (Step): The step that was just generated</span>

<span class="sd">    Returns:</span>
<span class="sd">        Step: The processed step, by default returns the original step unmodified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.prepare_tape" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">prepare_tape</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepares tape by filtering out control flow steps.</p>
<p>This method creates a new tape instance with only non-control flow steps,
specifically excluding SetNextNode instances.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The input tape containing a sequence of steps.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>Tape</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>
)          –
          <div class="doc-md-description">
            <p>A new tape instance containing only non-control flow steps.</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">prepare_tape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares tape by filtering out control flow steps.</span>

<span class="sd">    This method creates a new tape instance with only non-control flow steps,</span>
<span class="sd">    specifically excluding SetNextNode instances.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): The input tape containing a sequence of steps.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tape: A new tape instance containing only non-control flow steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">steps_without_control_flow</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">SetNextNode</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">tape</span><span class="o">.</span><span class="n">model_copy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps_without_control_flow</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.tape_to_messages" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">tape_to_messages</span><span class="p">(</span><span class="n">tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Converts a Tape object and steps description into a list of messages for LLM conversation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>A Tape object containing conversation steps.</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
            <b><code>steps_description</code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>A description of the conversation steps.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
              <code>list[dict]</code>
          –
          <div class="doc-md-description">
            <p>list[dict]: A list of dictionaries representing the conversation messages.
       Each dictionary contains 'role' and 'content' keys.
       Roles can be 'system', 'user', or 'assistant'.
       The system prompt is always the first message.
       If steps_description is provided, it's added as a user message.
       Messages from tape are added with roles based on step type.
       If guidance exists, it's added as the final user message.</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tape_to_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">,</span> <span class="n">steps_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a Tape object and steps description into a list of messages for LLM conversation.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): A Tape object containing conversation steps.</span>
<span class="sd">        steps_description (str): A description of the conversation steps.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[dict]: A list of dictionaries representing the conversation messages.</span>
<span class="sd">                   Each dictionary contains &#39;role&#39; and &#39;content&#39; keys.</span>
<span class="sd">                   Roles can be &#39;system&#39;, &#39;user&#39;, or &#39;assistant&#39;.</span>
<span class="sd">                   The system prompt is always the first message.</span>
<span class="sd">                   If steps_description is provided, it&#39;s added as a user message.</span>
<span class="sd">                   Messages from tape are added with roles based on step type.</span>
<span class="sd">                   If guidance exists, it&#39;s added as the final user message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">steps_description</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">steps_description</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tape</span><span class="p">:</span>
        <span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;assistant&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">AgentStep</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;user&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">step</span><span class="o">.</span><span class="n">llm_view</span><span class="p">()})</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guidance</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">guidance</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">messages</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.MonoNode.trim_tape" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">trim_tape</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Trims the tape by removing unnecessary positions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object to be trimmed.</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>Tape</code></b> (              <code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>
)          –
          <div class="doc-md-description">
            <p>The trimmed tape object.</p>
          </div>
        </li>
    </ul>


<details class="note" open>
  <summary>Note</summary>
  <p>Currently this is a placeholder method that returns the tape unchanged.</p>
</details>
            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">trim_tape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trims the tape by removing unnecessary positions.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): The tape object to be trimmed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tape: The trimmed tape object.</span>

<span class="sd">    Note:</span>
<span class="sd">        Currently this is a placeholder method that returns the tape unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">tape</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="tapeagents.nodes.ObservationControlNode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ObservationControlNode</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="tapeagents.nodes.ControlFlowNode" href="#tapeagents.nodes.ControlFlowNode">ControlFlowNode</a></code></p>


        <p>A control flow node that selects the next node based on the last observation in the tape.</p>
<p>This node examines the last observation in the tape and uses it to determine which node
to execute next based on a mapping of observation types to node names.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <ul>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.ObservationControlNode.observation_to_node">observation_to_node</span></code></b>
              (<code>dict[<span title="typing.Type">Type</span>, str]</code>)
          –
          <div class="doc-md-description">
            <p>Mapping of observation types to destination node names</p>
          </div>
        </li>
        <li class="doc-section-item field-body">
          <b><code><span title="tapeagents.nodes.ObservationControlNode.default_node">default_node</span></code></b>
              (<code>str</code>)
          –
          <div class="doc-md-description">
            <p>Default node to jump to if no matching observation type is found</p>
          </div>
        </li>
    </ul>


<details class="example" open>
  <summary>Example</summary>
  <pre><code class="language-python">node = ObservationControlNode(
    observation_to_node={
        SuccessObservation: &quot;success_node&quot;,
        ErrorObservation: &quot;error_node&quot;
    },
    default_node=&quot;fallback_node&quot;
)
</code></pre>
</details>








<p><span class="doc-section-title">Methods:</span></p>
    <ul>
          <li class="doc-section-item field-body">
            <b><code><a class="autorefs autorefs-internal" title="tapeagents.nodes.ObservationControlNode.select_node" href="#tapeagents.nodes.ObservationControlNode.select_node">select_node</a></code></b>
            –
            <div class="doc-md-description">
              <p>Selects the next node based on the type of the last observation in the tape.</p>
            </div>
          </li>
    </ul>



              <details class="quote">
                <summary>Source code in <code>tapeagents/nodes.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ObservationControlNode</span><span class="p">(</span><span class="n">ControlFlowNode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A control flow node that selects the next node based on the last observation in the tape.</span>

<span class="sd">    This node examines the last observation in the tape and uses it to determine which node</span>
<span class="sd">    to execute next based on a mapping of observation types to node names.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        observation_to_node (dict[Type, str]): Mapping of observation types to destination node names</span>
<span class="sd">        default_node (str): Default node to jump to if no matching observation type is found</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        node = ObservationControlNode(</span>
<span class="sd">            observation_to_node={</span>
<span class="sd">                SuccessObservation: &quot;success_node&quot;,</span>
<span class="sd">                ErrorObservation: &quot;error_node&quot;</span>
<span class="sd">            },</span>
<span class="sd">            default_node=&quot;fallback_node&quot;</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">observation_to_node</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">default_node</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># jump to the last node by default</span>

    <span class="k">def</span> <span class="nf">select_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects the next node based on the type of the last observation in the tape.</span>

<span class="sd">        Returns default_node if no observations exist or no matching type is found.</span>

<span class="sd">        Args:</span>
<span class="sd">            tape (Tape): The tape object containing the context and state</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of the next node to execute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">Observation</span><span class="p">)]</span>
        <span class="n">last_observation</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">observations</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_to_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">last_observation</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="tapeagents.nodes.ObservationControlNode.select_node" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">select_node</span><span class="p">(</span><span class="n">tape</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Selects the next node based on the type of the last observation in the tape.</p>
<p>Returns default_node if no observations exist or no matching type is found.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <ul>
        <li class="doc-section-item field-body">
            <b><code>tape</code></b>
              (<code><a class="autorefs autorefs-internal" title="tapeagents.core.Tape" href="../core/#tapeagents.core.Tape">Tape</a></code>)
          –
          <div class="doc-md-description">
            <p>The tape object containing the context and state</p>
          </div>
        </li>
    </ul>


<p><span class="doc-section-title">Returns:</span></p>
    <ul>
        <li class="doc-section-item field-body">
<b><code>str</code></b> (              <code>str</code>
)          –
          <div class="doc-md-description">
            <p>The name of the next node to execute</p>
          </div>
        </li>
    </ul>

            <details class="quote">
              <summary>Source code in <code>tapeagents/nodes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">select_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape</span><span class="p">:</span> <span class="n">Tape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Selects the next node based on the type of the last observation in the tape.</span>

<span class="sd">    Returns default_node if no observations exist or no matching type is found.</span>

<span class="sd">    Args:</span>
<span class="sd">        tape (Tape): The tape object containing the context and state</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The name of the next node to execute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">tape</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">Observation</span><span class="p">)]</span>
    <span class="n">last_observation</span> <span class="o">=</span> <span class="n">observations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">observations</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_to_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">last_observation</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>